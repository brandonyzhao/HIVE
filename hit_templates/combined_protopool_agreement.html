<html>
  <head>
    <title>Evaluating interpretability</title>
    <!-- simpleamt depends on these libraries -->
    <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js'></script>
    <!-- end of required libraries -->
    <script src='//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- mozilla pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.0.943/pdf.min.js"></script>
    <style>
      #text-area {
        margin: 10px 0;
        font-size: 24pt;
      }
      #button-div {
        margin-bottom: 10px;
      }
      #feedback-area {
        margin: 10px 0;
        font-size: 24pt;
      }
      #counter {
        margin: 0 10px;
        font-size: 20pt;
        font-weight: bold;
      }
      #slider-low {
        width: 100%;
        margin: 2em auto;
      }
      #slider-low label {
        position: absolute;
        width: 20px;
        margin-top: 20px;
        margin-left: -10px;
        text-align: center;
      }
      #slider-med {
        width: 100%;
        margin: 2em auto;
      }
      #slider-med label {
        position: absolute;
        width: 20px;
        margin-top: 20px;
        margin-left: -10px;
        text-align: center;
      }
      #slider-high {
        width: 100%;
        margin: 2em auto;
      }
      #slider-high label {
        position: absolute;
        width: 20px;
        margin-top: 20px;
        margin-left: -10px;
        text-align: center;
      }
      p {
        font-size: 18px;
      }
      .btn-group button {
        background-color: #3e3d3d; /* Green background */
        border: 1px solid rgb(0, 0, 0); /* Green border */
        color: white; /* White text */
        padding: 10px 24px; /* Some padding */
        cursor: pointer; /* Pointer/hand icon */
        width: 50%; /* Set a width if needed */
        display: block; /* Make the buttons appear below each other */
      }
      table, th, td {
        border: none;
        width=100%;
        white-space:nowrap;
        table-layout: auto;
        padding: 10px;
      }
      table {
        border-collapse: collapse;
        border-spacing: 0;
        padding: 20px;
      }

      p, ul, ol, dl, table {
        margin-bottom: 1em;
        padding: 20px;
        margin: 0px;
        padding: 0px;
        border: 0px;
        font-size: 100%;
        font: inherit;
        vertical-align: baseline;
      }
      .right {
        transform: rotate(-45deg);
        -webkit-transform: rotate(-45deg);
      }
      .left {
        transform: rotate(135deg);
        -webkit-transform: rotate(135deg);
      }
      .up {
        transform: rotate(-135deg);
        -webkit-transform: rotate(-135deg);
      }
      .down {
        transform: rotate(45deg);
        -webkit-transform: rotate(45deg);
      }
      img {
        height: auto;
        width: 100%;
      }
      iframe {
        width: 100%;
        height: 50%;
      }
      hr {
        display: block;
        height: 1px;
        border: 0;
        border-top: 1px solid #ccc;
        margin: 1em 0;
        padding: 0;
      }
      li {
        font-size: 18px;
      }
      .row_special {
        display: grid;
        grid-auto-flow: column;
        gap: 10%;
      }

      .col_special {
        display: grid;
        grid-auto-flow: row;
        align-items: center;
      }
      .double {
        zoom: 1.5;
        transform: scale(2);
        -ms-transform: scale(2);
        -webkit-transform: scale(2);
        -o-transform: scale(2);
        -moz-transform: scale(2);
        transform-origin: 0 0;
        -ms-transform-origin: 0 0;
        -webkit-transform-origin: 0 0;
        -o-transform-origin: 0 0;
        -moz-transform-origin: 0 0;
      }
    </style>
  </head>

  <body>

    <!-- Demographics and background -->
    {% include "hit_templates/setup.html" %}


    <!-- Model introduction -->
    <div class='container-fluid' id="part_intro" style="display: none; ">
      <div class='container-fluid'>
        <h1>Model introduction</h1>
        <p style="font-size:18px">
          We have a model that recognizes 200 bird species in photos.
          We have access to its prediction and an explanation for it.
          <br>
          <b>Please carefully read this page as the remaining study depends on your understanding of the model.</b>
        </p>
        <br>
        {% include "hit_templates/intro_protopool.html" %}
        <br>
        <div class='col-xs-12' id='button-div'>
          <button class='btn btn-lg btn-primary' id="next_intro2preview" onclick="pg_intro2preview()">Next Page</button>
        </div>
        <br><br><br>
      </div>
    </div>

    <!-- Task preview & Examples -->
    <div class='container-fluid' id="part_preview" style="display: none; ">


    <br><br>

    <!-- Example explanations -->
    <div class='container-fluid'>
      <h1>Example explanations</h1>
      <p>
        Below we show examples of a correct prediction and an incorrect prediction.
        Please examine them and rate your level of understanding of the model.
      </p>
    </div>
    <div class='container-fluid'>
      <div class='col-xs-4'>
        <h3>Correct prediction</h3>
        <div id='correct1-container'></div>
      </div>
      <div class='col-xs-1'></div>
      <div class='col-xs-4'>
        <h3>Incorrect prediction</h3>
        <div id='incorrect-container'></div>
      </div>
    </div>

    <br>
    <br>

    <div class='container-fluid'>
      <h3>Q. How well do you think you understand the model's reasoning process?</h3>
      <form action="" method="post">
        <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective" value="1" /> <span style="font-size:18px">Very Poor</span>
        <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective" value="2" /> <span style="font-size:18px">Poor</span>
        <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective" value="3" /> <span style="font-size:18px">Fair</span>
        <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective" value="4" /> <span style="font-size:18px">Good</span>
        <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective" value="5" /> <span style="font-size:18px">Very Good</span>
      </form>
    </div>

    <br><br><br>

    <div class='col-xs-12' id='button-div'>
      <button class='btn btn-lg btn-primary' id="next_preview2task" disabled onclick="pg_preview2task()">Next Page</button>
      <br><br>
    </div>

    <br><br>

    </div> <!-- End of part_preview -->

    <!-- Main task -->
    {% include "hit_templates/task_protopool_agreement.html" %}


    <!-- Post-task evaluation -->
    <div class='container-fluid' id='part_post' style="display: none;">
      <div class='container-fluid'>
        <h1>Post-task evaluation</h1>
        <br>
        <h3>Q. How well do you think you understand the model's reasoning process?</h3>
        <form action="" method="post">
          <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective2" value="1" /> <span style="font-size:18px">Very Poor</span>
          <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective2" value="2" /> <span style="font-size:18px">Poor</span>
          <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective2" value="3" /> <span style="font-size:18px">Fair</span>
          <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective2" value="4" /> <span style="font-size:18px">Good</span>
          <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective2" value="5" /> <span style="font-size:18px">Very Good</span>
        </form>
      </div>
      <br><br><br>
      <div class='col-xs-12' id='button-div'>
        <button class='btn btn-lg btn-primary' id="next_post2perf"  onclick="pg_post2perf()">Next Page</button>
      </div>
    </div>

    <!-- Your performance -->
    <div class='container-fluid' id='part_perf' style="display: none;">
      <div class='container-fluid'>
        <h1>Your performance</h1>
        <br>
        <p>
          In the previous task, 5 of 10 photos were correct predictions and the remaining 5 were incorrect predictions.
          <br>
          <br>
          If we assign the 5 predictions with your highest &#34;confident that
          prediction is correct&#34; rating to correct and the rest as incorrect,
          <b>
            you identified <span id="correctcount"></span> out of <span id="correcttotal"></span>
            correct predictions and <span id="wrongcount"></span> out of <span id="wrongtotal"></span>
            incorrect predictions.
          </b>
          <br>
          <br>
          Here are the individual answers you selected.
          <br>
          <br>
          <b>For the 5 correct predictions, you responded:</b>
          <br>
          1. <span id="c11"></span><br>
          2. <span id="c12"></span><br>
          3. <span id="c13"></span><br>
          4. <span id="c14"></span><br>
          5. <span id="c15"></span><br>
          <br>
          <b>For the 5 incorrect predictions, you responded:</b>
          <br>
          1. <span id="inc11"></span><br>
          2. <span id="inc12"></span><br>
          3. <span id="inc13"></span><br>
          4. <span id="inc14"></span><br>
          5. <span id="inc15"></span><br>

        </p>
        <br>
        <h3>Q. How well do you think you understand the model's reasoning process?</h3>
        <form action="" method="post">
          <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective3" value="1" /> <span style="font-size:18px">Very Poor</span>
          <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective3" value="2" /> <span style="font-size:18px">Poor</span>
          <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective3" value="3" /> <span style="font-size:18px">Fair</span>
          <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective3" value="4" /> <span style="font-size:18px">Good</span>
          <input type="radio" style="height:18px; width:18px; vertical-align:top;" name="subjective3" value="5" /> <span style="font-size:18px">Very Good</span>
        </form>
      </div>
      <br><br><br>
      <div class='col-xs-12' id='button-div'>
        <button class='btn btn-lg btn-primary' id="next_perf2choice"  onclick="pg_perf2choice()">Next Page</button>
      </div>
    </div>

    <!-- Choose which model to use -->
    {% include "hit_templates/choice_protopool_agreement.html" %}

    <!-- Feedback -->
    <div class='container-fluid' id='part_feedback' style="display: none;">
      <div class='col-xs-12'>
        <h3>
          Thank you for your participation!
          <br><br>
          Let us know if you have any feedback about this study.
        </h3>
        <textarea id='feedback-area' name='feedback-area' class='form-control tb-margin'></textarea>
      </div>

      <!-- Submit -->
      {% include "hit_templates/simpleamt.html" %}
    </div>


    <!-- For slider -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>

    <script>
      $('#consent-pdf').empty();
      $('<embed>').attr(
        {'src':'https://drive.google.com/file/d/1Gsqa86_NQXtySCo9Qxe8sOAPA-EOTy7P/preview', 'type':'application/pdf', 'width':'100%', 'height':'70%'}
      ).appendTo($('#consent-pdf'));

      $( function() {
        // Low-risk
        $( "#slider-low" ).slider({
            value: 80, min: 70, max: 100, step: 1,
            slide: function (e, ui) {
                document.getElementById("low_risk").innerHTML = $('#slider-low').slider("option", "value");
            },
            stop: function (e, ui) {
                document.getElementById("low_risk").innerHTML = $('#slider-low').slider("option", "value");
            }
        })
        .each(function() {
          var opt = $('#slider-low').data().uiSlider.options;
          var vals = opt.max - opt.min;
          for (var i = 0; i <= vals; i++) {
            var el = $('<label>'+(opt.min+i)+'</label>').css('left',(i/vals*100)+'%');
            $("#slider-low").append(el);
          }
        });
        document.getElementById("low_risk").innerHTML = $('#slider-low').slider("option", "value");

        // Med-risk
        $( "#slider-med" ).slider({
            value: 80, min: 70, max: 100, step: 1,
            slide: function (e, ui) {
                document.getElementById("med_risk").innerHTML = $('#slider-med').slider("option", "value");
            },
            stop: function (e, ui) {
                document.getElementById("med_risk").innerHTML = $('#slider-med').slider("option", "value");
            }
        })
        .each(function() {
          var opt = $('#slider-med').data().uiSlider.options;
          var vals = opt.max - opt.min;
          for (var i = 0; i <= vals; i++) {
            var el = $('<label>'+(opt.min+i)+'</label>').css('left',(i/vals*100)+'%');
            $("#slider-med").append(el);
          }
        });
        document.getElementById("med_risk").innerHTML = $('#slider-med').slider("option", "value");

        // High-risk
        $( "#slider-high" ).slider({
            value: 80, min: 70, max: 100, step: 1,
            slide: function (e, ui) {
                document.getElementById("high_risk").innerHTML = $('#slider-high').slider("option", "value");
            },
            stop: function (e, ui) {
                document.getElementById("high_risk").innerHTML = $('#slider-high').slider("option", "value");
            }
        })
        .each(function() {
          var opt = $('#slider-high').data().uiSlider.options;
          var vals = opt.max - opt.min;
          for (var i = 0; i <= vals; i++) {
            var el = $('<label>'+(opt.min+i)+'</label>').css('left',(i/vals*100)+'%');
            $("#slider-high").append(el);
          }
        });
        document.getElementById("high_risk").innerHTML = $('#slider-high').slider("option", "value");
      });

    </script>



    <script>
      function movepage(div_prev, div_next) {
        if (div_prev.style.display !== 'none') {
          div_prev.style.display = 'none';
          div_next.style.display = 'block';
        }
        else {
          div_prev.style.display = 'block';
          div_next.style.display = 'none';
        }
        // Jump to the top of the page
        window.scroll({
          top: 0,
          left: 0,
          behavior: 'smooth'
        });
      }

      // Create timing object
      timing = {};
      timing['start'] = Date.now();
      timing['pg_method'] = [];
      timing['nextphoto'] = [];

      // Move between pages
      function pg_consent2demographics() {
        timing['pg_consent2demographics'] = Date.now();
        var div_prev = document.getElementById('part_consent');
        var div_next = document.getElementById('part_demographics');
        movepage(div_prev, div_next);
      }
      function pg_demographics2intro() {
        timing['pg_demographics2intro'] = Date.now();
        var div_prev = document.getElementById('part_demographics');
        var div_next = document.getElementById('part_intro');
        movepage(div_prev, div_next);
      }

      function pg_intro2preview() {
        timing['pg_intro2preview'] = Date.now();
        var div_prev = document.getElementById('part_intro');
        var div_next = document.getElementById('part_preview');
        movepage(div_prev, div_next);
      }
      function pg_preview2task() {
        timing['pg_preview2task'] = Date.now();
        var div_prev = document.getElementById('part_preview');
        var div_next = document.getElementById('part_task');
        movepage(div_prev, div_next);
      }
      function pg_task2post() {
        timing['pg_task2post'] = Date.now();
        var div_prev = document.getElementById('part_task');
        var div_next = document.getElementById('part_post');
        movepage(div_prev, div_next);
      }
      function pg_post2perf() {
        timing['pg_post2perf'] = Date.now();
        var div_prev = document.getElementById('part_post');
        var div_next = document.getElementById('part_perf');
        movepage(div_prev, div_next);
      }
      function pg_perf2choice() {
        timing['pg_perf2choice'] = Date.now();
        var div_prev = document.getElementById('part_perf');
        var div_next = document.getElementById('part_choice');
        movepage(div_prev, div_next);
      }
      function pg_choice2feedback() {
        timing['pg_choice2feedback'] = Date.now();
        var div_prev = document.getElementById('part_choice');
        var div_next = document.getElementById('part_feedback');
        movepage(div_prev, div_next);
      }
      function pg_method() {
        timing['pg_method'][timing['pg_method'].length] = Date.now();
        var div_method = document.getElementById('part_method');
        if (div_method.style.display == 'none') {
          div_method.style.display = 'block';
        }
        else {
          div_method.style.display = 'none';
        }
      }

      function add(accumulator, a) {
        return accumulator + a;
      }

      function median(values){
        values.sort(function(a,b){
          return a-b;
        });
        var half = Math.floor(values.length / 2);
        if (values.length % 2)
          return values[half];
        else
          return (values[half - 1] + values[half]) / 2.0;
      };

      var confidence_to_words = {'4': "Fairly confident that prediction is <i>correct</i>",
      '3': "Somewhat confident that prediction is <i>correct</i>",
      '2': "Somewhat confident that prediction is <u>incorrect</u>",
      '1': "Fairly confident that prediction is <u>incorrect</u>"}

      // Define some default input.
      var DEFAULT_INPUT = { "correct1": [ "https://drive.google.com/uc?export=view&id=1PqhpNOmeNUyLi2DpGspPd8TZGHV4g0sn" ], "correct2": [ "https://drive.google.com/uc?export=view&id=1PqhpNOmeNUyLi2DpGspPd8TZGHV4g0sn" ], "incorrect": [ "https://drive.google.com/uc?export=view&id=1Qmz2J3Pe_7hzIMg8LinxjFhFL9orr2l2" ], "input_image": [ "https://drive.google.com/uc?export=view&id=1jOJincXT0GfFzu3RYQSnQQxKkR9mBZtM", "https://drive.google.com/uc?export=view&id=1LfNEYaxHDQwuWU9qFjlMQVmqypUJx1c9", "https://drive.google.com/uc?export=view&id=1yc0zLSDzKke6564jmAt4817v1r3UstbT", "https://drive.google.com/uc?export=view&id=1idf31xAypJ8HwG0PyjNHQIr_s2q0BS_V", "https://drive.google.com/uc?export=view&id=18mt7fpoOJPrltTT4v_3OhlZw8Hzz8tHd", "https://drive.google.com/uc?export=view&id=15xsHcf0iWq6AwkXA1XpEkjgsASWb9cgj", "https://drive.google.com/uc?export=view&id=1l94a8gxcH_bJks9-3zvC3MgWdh9ss43V", "https://drive.google.com/uc?export=view&id=1gSswksyDnnrCZoqokcNOBlOOW6F8XTBO", "https://drive.google.com/uc?export=view&id=13_KdO3dNRGPC_8wI_RgClsmiYGxJsf_O", "https://drive.google.com/uc?export=view&id=1HYPY3kHjb40N3d5ga66gCIvqHhf2Ps0b" ], "input_prediction": [ 1, 2, 3, 7, 8, 9, 4, 5, 6, 10 ], "input_explanation": [ "https://drive.google.com/uc?export=view&id=1SUSrjWwoHILs8XgB1Sj43x-dvSVxhpbP", "https://drive.google.com/uc?export=view&id=1jgha9pb2rXxjMNOAsXxW_TE3Ta9-U8pJ", "https://drive.google.com/uc?export=view&id=1M15GyABkwkTDjD4AbDy97bVrFN0HjhTj", "https://drive.google.com/uc?export=view&id=1z3-2odi1bojtxNPwgpnUycZlDKHyAE4l", "https://drive.google.com/uc?export=view&id=1R1_Ifun8uOuuyJ0ZU-FE2mHRsCG16XqA", "https://drive.google.com/uc?export=view&id=1h7Z-ArwB2KZ6RmjIvr5IGd1veUgH9Ddd", "https://drive.google.com/uc?export=view&id=12qe42AZklcgyFtaFC5tJXL1AFGsjG3IL", "https://drive.google.com/uc?export=view&id=1palc--aMacEMfTuxSWUVB8H3O4uYpB5_", "https://drive.google.com/uc?export=view&id=1bzXIIJzpdxm9bF3H4me-ICGdXAFjKRzC", "https://drive.google.com/uc?export=view&id=15AVztcqk-EhKAn7VyF0E8kzv-n5Hg9w4" ], "ground_truth": [ "Correct", "Incorrect", "Correct", "Correct", "Incorrect", "Incorrect", "Correct", "Correct", "Incorrect", "Incorrect" ], "num_prototypes": [ 3, 3, 3, 3, 3, 3, 3, 3, 3, 3 ], "input_id": [ 0 ] }
      
      // Variables to record answers
      var answers = [];
      var descriptions = [];
      var feedback = [];

      // Some variables to track state of the HIT.
      var enabled = false;
      var longinput = null;

      var localanswers = [];
      var idx = 0;

      var correctacclist = [];
      var wrongacclist = [];
      var correcttotal = [];
      var wrongtotal = [];

      var checked_radiobtns = new Array(10).fill(0);

      var origacc = 79.9;
      document.getElementById("origacc").innerHTML = origacc;
      document.getElementById("origacc_copy1").innerHTML = origacc;
      document.getElementById("origacc_copy2").innerHTML = origacc;
      document.getElementById("origacc_copy3").innerHTML = origacc;


      function record() {
        checked_radiobtns= new Array(10).fill(0);

        timing['nextphoto'][idx] = Date.now();

        var selected = [];
        $('#checkboxes_distinction input:checked').each(function() {
            selected.push($(this).attr('value'));
        });

        console.log("selected: "+selected);
        localanswers[idx] = {
          'confidence': parseInt($('input[name=confidence]:checked').val(), 10),
          'selected': selected,
        };

        // Reset the checkboxes
        $('#checkboxes_distinction input:checked').each(function() {
          $(this).prop( "checked", false );
        });

        // Calculate accuracy
        correctacclist = [];
        wrongacclist = [];
        correcttotal = [];
        wrongtotal = [];

        if (idx == 9) {
          // localanswers is currently confidence ratings. Must convert to "correct"/"incorrect"
          // calculate the median of the ratings
          localanswers_confidence = [];
          for (var i = 0; i < localanswers.length; ++i) {
            localanswers_confidence.push(localanswers[i]['confidence'])
          };

          console.log("localanswers_confidence: "+localanswers_confidence);
          localanswers_deepcopy = JSON.parse(JSON.stringify(localanswers_confidence));
          var median_la = median(localanswers_deepcopy);

          var incor_count = 0;
          var cor_count = 0;
          localanswers_new = Array(10);
          for (var i = 0; i < input_image.length; ++i) {
            if (localanswers[i]['confidence'] > median_la) {
              // for all nums greater than median: "Correct"
              localanswers_new[i] = 'Correct';
              cor_count++;
            }
            // for all num less than median: "Incorrect"
            if (localanswers[i]['confidence'] < median_la) {
              localanswers_new[i] = 'Incorrect';
              incor_count++;
            }
            if (localanswers[i]['confidence'] == median_la) {
              localanswers_new[i] = 'TBD';
            }
          };

          console.log("localanswers_new1: "+localanswers_new);

          num_to_label_incor = 5-incor_count;
          num_to_label_cor = 5-cor_count;
          if (num_to_label_incor > 5) {num_to_label_incor=5;};
          if (num_to_label_cor > 5) {num_to_label_cor=5;};

          // in case the median doesn't split this into two even halves,
          for (var i = 0; i < input_image.length; ++i) {
            // label 5-num_incorrect as incorrect
            // label 5-num_correct as correct

            if (localanswers_new[i] === 'TBD') {
              // Randomly choose correct (0) or incorrect (1)
              var cor_incor_choice = Math.floor(Math.random() * 2);

              if (cor_incor_choice==0) {
                if (num_to_label_cor > 0) {
                  localanswers_new[i] = 'Correct';
                  num_to_label_cor--;
                  cor_count++;
                }
                else {
                  localanswers_new[i] = 'Incorrect';
                  incor_count++;
                  num_to_label_incor--;
                }
              }
              else {
                if (num_to_label_incor > 0) {
                  localanswers_new[i] = 'Incorrect';
                  incor_count++;
                  num_to_label_incor--;
                }
                else {
                  localanswers_new[i] = 'Correct';
                  num_to_label_cor--;
                  cor_count++;
                }
              }
            }
          };

          // show the user their classifcations
          var correct_counter = 1;
          var incorrect_counter = 1;
          for (var i = 0; i < input_image.length; ++i) {
            if (ground_truth[i] == 'Correct') {
              document.getElementById("c1"+String(correct_counter)).innerHTML = confidence_to_words[String(localanswers_confidence[i])];
              correct_counter++;
            }
            else {
              document.getElementById("inc1"+String(incorrect_counter)).innerHTML = confidence_to_words[String(localanswers_confidence[i])];
              incorrect_counter++;
            }
          }
          console.log("localanswers_new2: "+localanswers_new);
          for (var i = 0; i < input_image.length; ++i) {
            if (ground_truth[i] == 'Correct') {
              if (localanswers_new[i] == ground_truth[i]) {
                correctacclist[i] = 1;
              } else {
                correctacclist[i] = 0;
              }
              correcttotal[i] = 1;
            } else {
              if (localanswers_new[i] == ground_truth[i]) {
                wrongacclist[i] = 1;
              } else {
                wrongacclist[i] = 0;
              }
              wrongtotal[i] = 1;
            }
          }
          console.log('correctacclist: '+correctacclist);
          console.log('wrongacclist: '+wrongacclist);

          var correctcount = correctacclist.reduce(function(a, b) { return Number(a) + Number(b); }, 0);
          var wrongcount = wrongacclist.reduce(function(a, b) { return Number(a) + Number(b); }, 0);
          var correcttotal = correcttotal.reduce(function(a, b) { return Number(a) + Number(b); }, 0);
          var wrongtotal = wrongtotal.reduce(function(a, b) { return Number(a) + Number(b); }, 0);
          var correctacc = correctcount / correcttotal;
          var wrongacc = wrongcount / wrongtotal;
          // var compoundacc = origacc/100*correctacc + (1-origacc/100)*wrongacc;
          console.log("correctcount:" +correctcount);
          console.log("wrongcount: "+ wrongcount);

          document.getElementById("correctcount").innerHTML = correctcount;
          document.getElementById("wrongcount").innerHTML = wrongcount;
          document.getElementById("correcttotal").innerHTML = correcttotal;
          document.getElementById("wrongtotal").innerHTML = wrongtotal;
          document.getElementById("correctcount2").innerHTML = correctcount;
          document.getElementById("wrongcount2").innerHTML = wrongcount;
          document.getElementById("correcttotal2").innerHTML = correcttotal;
          document.getElementById("wrongtotal2").innerHTML = wrongtotal;
        }
      }


      $(function() {

        $("input[name='consent']").change(function(){next_consent2demographics.disabled = false;});
        $("input[name='ml_exp']").change(function(){next_demographics2intro.disabled = false;});
        $("input[name='subjective']").change(function(){next_preview2task.disabled = false;});
        $("input[name='subjective2']").change(function(){next_post2perf.disabled = false;});
        $("input[name='subjective3']").change(function(){next_perf2choice.disabled = false;});

        $("input[name='similarity1']").change(function(){
          // if the radio button is not checked yet, increment the counter
          checked_radiobtns[0] = 1;
          if (($("input[name='confidence']").is(":checked")) && (checked_radiobtns.reduce(add, 0)==num_prototypes[idx])) {
            if (idx != 9) {next_btn.disabled = false;}
            if (idx == 9) {next_task2post.disabled = false;}
          };
        });

        $("input[name='similarity2']").change(function(){
          // if the radio button is not checked yet, increment the counter
          checked_radiobtns[1] = 1;
          if (($("input[name='confidence']").is(":checked")) && (checked_radiobtns.reduce(add, 0)==num_prototypes[idx])) {
            if (idx != 9) {next_btn.disabled = false;}
            if (idx == 9) {next_task2post.disabled = false;}
          };
        });
        $("input[name='similarity3']").change(function(){
          // if the radio button is not checked yet, increment the counter
          checked_radiobtns[2] = 1;
          if (($("input[name='confidence']").is(":checked")) && (checked_radiobtns.reduce(add, 0)==num_prototypes[idx])) {
            if (idx != 9) {next_btn.disabled = false;}
            if (idx == 9) {next_task2post.disabled = false;}
          };
        });
        $("input[name='similarity4']").change(function(){
          // if the radio button is not checked yet, increment the counter
          checked_radiobtns[3] = 1;
          if (($("input[name='confidence']").is(":checked")) && (checked_radiobtns.reduce(add, 0)==num_prototypes[idx])) {
            if (idx != 9) {next_btn.disabled = false;}
            if (idx == 9) {next_task2post.disabled = false;}
          };
        });
        $("input[name='similarity5']").change(function(){
          // if the radio button is not checked yet, increment the counter
          checked_radiobtns[4] = 1;
          if (($("input[name='confidence']").is(":checked")) && (checked_radiobtns.reduce(add, 0)==num_prototypes[idx])) {
            if (idx != 9) {next_btn.disabled = false;}
            if (idx == 9) {next_task2post.disabled = false;}
          };
        });
        $("input[name='similarity6']").change(function(){
          // if the radio button is not checked yet, increment the counter
          checked_radiobtns[5] = 1;
          if (($("input[name='confidence']").is(":checked")) && (checked_radiobtns.reduce(add, 0)==num_prototypes[idx])) {
            if (idx != 9) {next_btn.disabled = false;}
            if (idx == 9) {next_task2post.disabled = false;}
          };
        });
        $("input[name='similarity7']").change(function(){
          // if the radio button is not checked yet, increment the counter
          checked_radiobtns[6] = 1;
          if (($("input[name='confidence']").is(":checked")) && (checked_radiobtns.reduce(add, 0)==num_prototypes[idx])) {
            if (idx != 9) {next_btn.disabled = false;}
            if (idx == 9) {next_task2post.disabled = false;}
          };
        });
        $("input[name='similarity8']").change(function(){
          // if the radio button is not checked yet, increment the counter
          checked_radiobtns[7] = 1;
          if (($("input[name='confidence']").is(":checked")) && (checked_radiobtns.reduce(add, 0)==num_prototypes[idx])) {
            if (idx != 9) {next_btn.disabled = false;}
            if (idx == 9) {next_task2post.disabled = false;}
          };
        });
        $("input[name='similarity9']").change(function(){
          // if the radio button is not checked yet, increment the counter
          checked_radiobtns[8] = 1;
          if (($("input[name='confidence']").is(":checked")) && (checked_radiobtns.reduce(add, 0)==num_prototypes[idx])) {
            if (idx != 9) {next_btn.disabled = false;}
            if (idx == 9) {next_task2post.disabled = false;}
          };
        });
        $("input[name='similarity10']").change(function(){
          // if the radio button is not checked yet, increment the counter
          checked_radiobtns[9] = 1;
          if (($("input[name='confidence']").is(":checked")) && (checked_radiobtns.reduce(add, 0)==num_prototypes[idx])) {
            if (idx != 9) {next_btn.disabled = false;}
            if (idx == 9) {next_task2post.disabled = false;}
          };
        });

        $("input[name='confidence']").change(function(){
          if (($("input[name='confidence']").is(":checked")) && (checked_radiobtns.reduce(add, 0)==num_prototypes[idx])) {
            if (idx != 9) {next_btn.disabled = false;}
            if (idx == 9) {next_task2post.disabled = false;}
         }
        });


        function main() {
          // If this is a HIT on AMT, then replace the default input with the real input.
          longinput = simpleamt.getInput(DEFAULT_INPUT);

          correct1 = longinput['correct1']
          correct2 = longinput['correct2']
          incorrect = longinput['incorrect']
          input_image = longinput['input_image']
          input_prediction = longinput['input_prediction']
          input_explanation = longinput['input_explanation']
          ground_truth = longinput['ground_truth']
          num_prototypes = longinput['num_prototypes']
          input_id = longinput['input_id'][0]

          // Enable the UI if the HIT is not in preview mode.
          if (!simpleamt.isPreview()) {
            enable_hit();
          }

          // Set up the descriptions.
          _.each(input, function() { descriptions.push(''); });
          _.each(input, function() { feedback.push(''); });

          // Preload all images
          _.each(correct1, function(img_url) {
            var img = new Image();
            img.onload = function() { console.log('loaded image from ' + img_url); };
            img.src = img_url;
          });
          _.each(correct2, function(img_url) {
            var img = new Image();
            img.onload = function() { console.log('loaded image from ' + img_url); };
            img.src = img_url;
          });
          _.each(incorrect, function(img_url) {
            var img = new Image();
            img.onload = function() { console.log('loaded image from ' + img_url); };
            img.src = img_url;
          });
          _.each(input_image, function(img_url) {
            var img = new Image();
            img.onload = function() { console.log('loaded image from ' + img_url); };
            img.src = img_url;
          });
          _.each(input_explanation, function(img_url) {
            var img = new Image();
            img.onload = function() { console.log('loaded image from ' + img_url); };
            img.src = img_url;
          });

          render();
        }

        // Use the current index to update the image and description
        function render() {

          // Jump to the top of the page
          window.scroll({
            top: 0,
            left: 0,
            behavior: 'smooth'
          });

          for (let i = 1; i < 11; i++) {
              id_text = 'row'+i;
              document.getElementById(id_text).style.display = 'block';
            };

          if (num_prototypes[idx] < 10) {
            for (let i = num_prototypes[idx] + 1; i < 11; i++) {
              id_text = 'row'+i;
              document.getElementById(id_text).style.display = 'none';
            };
          };

          for (let i = 1; i < 11; i++) {
            id_text = 'row'+i;
            console.log("document.getElementById("+id_text+").style.display: "+document.getElementById(id_text).style.display);
          };

          // 1_intro: 2 correct, 1 incorrect
          $('#correct1-container').empty(); $('<img>').attr('src', correct1[0]).appendTo($('#correct1-container'));
          $('#correct2-container').empty(); $('<img>').attr('src', correct2[0]).appendTo($('#correct2-container'));
          $('#incorrect-container').empty(); $('<img>').attr('src', incorrect[0]).appendTo($('#incorrect-container'));

          // 2_distinguish: Set up the image
          $('#testimage-container').empty();
          $('<img>').attr({
            'src':input_image[idx], 'height':'20%', 'align':'center'
          }).appendTo($('#testimage-container'));

          // 2_distinguish: Set up the explanation
          $('#pdf-container').empty(); $('<img>').attr('src', input_explanation[idx]).appendTo($('#pdf-container'));

          // 2_distinguish: Set up the prediction
          document.getElementById("Prediction").innerHTML = input_prediction[idx];
          document.getElementById("Prediction2").innerHTML = input_prediction[idx];

          // 3_choose: Set up the text area
          $('#text-area').val(descriptions);
          $('#feedback-area').val(feedback);

          // Refresh the counter
          $('.counter-top').text(idx + 1);
          $('.counter-bottom').text(input_image.length);


          // If the UI is enabled, enable or disable the buttons depending on the index.
          if (enabled) {
            var next_task2post_btn = $('#next_task2post');
            next_task2post_btn.prop('disabled', true);
          }

        }

        // Save the input and update the index
        function set_idx(new_idx) {
          if (new_idx < 0 || new_idx >= input_image.length) return;
          idx = new_idx;
          render();
        }

        // Enable the UI.
        function enable_hit() {
          enabled = true;

          // Enable components
          $('#next_btn').click(function() {
            set_idx(idx + 1);
            $('input[name=confidence]').prop('checked',false);
            next_btn.disabled = true;
          });

          $('#text-area').prop('disabled', false);
          $('#feedback-area').prop('disabled', false);
          $('#submit-btn').prop('disabled', false);

          // Set up submit handler.
          simpleamt.setupSubmit();
          $('#submit-btn').click(function() {

            timing['submit'] = Date.now();

            // Choice answers
            ml_exp = $('input[name=ml_exp]:checked').val();
            subjective = $('input[name=subjective]:checked').val();
            subjective2 = $('input[name=subjective2]:checked').val();
            subjective3 = $('input[name=subjective3]:checked').val();

            // distinguish
            correctcount = document.getElementById("correctcount").innerHTML;
            wrongcount = document.getElementById("wrongcount").innerHTML;

            // sliders
            low_risk = [];
            med_risk = [];
            high_risk = [];
            low_risk.push(document.getElementById("low_risk").innerHTML);
            med_risk.push(document.getElementById("med_risk").innerHTML);
            high_risk.push(document.getElementById("high_risk").innerHTML);

            gender = [];
            race = [];

            if ($('input[name=gender]:checked').length > 0) {
              gender.push($('input[name=gender]:checked').val());
            }
            else {
              gender.push("");
            };
            if ($('input[name=race]:checked').length > 0) {
              race.push($('input[name=race]:checked').val());
            }
            else {race.push("");};

            if (gender.length === 0) {gender = [''];};
            if (race.length === 0) {race = [''];};

            gender_written = []
            gender_written.push($('#genderdescribe').val());

            // Descriptions of reasons
            descriptions = []
            descriptions.push($('#text-area').val());
            feedback = []
            feedback.push($('#feedback-area').val());

            // Return output


            var output = _.map(_.zip(ml_exp,
              subjective, subjective2, subjective3,
              correctcount, wrongcount,
              low_risk, med_risk, high_risk,
              descriptions, gender, race, feedback, gender_written), function(x) {
              return {'ml_exp': x[0],
              'subjective': x[1], 'subjective2': x[2], 'subjective3': x[3],
              'correctcount': x[4], 'wrongcount': x[5],
              'low_risk': x[6], 'med_risk':x[7], 'high_risk':x[8],
              'descriptions': x[9],
              'gender': x[10], 'race': x[11], 'feedback': x[12], 'gender_written': x[13]};
            });
            // push the checked outputs in distinction task
            output.push({"input": input_id});
            output.push({"individual_answers": localanswers});
            output.push({'correctacclist': correctacclist});
            output.push({'wrongacclist': wrongacclist});
            output.push({"timing": timing});

            simpleamt.setOutput(output);

          });
        }

        main();

      });


    </script>
  </body>
</html>
